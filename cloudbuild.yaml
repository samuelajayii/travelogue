---
steps:
  - name: "gcr.io/cloud-builders/npm"
    args: ["install"]

  - name: "gcr.io/cloud-builders/npm"
    args: ["run", "build"]

  - name: "gcr.io/cloud-builders/docker"
    id: Docker Login
    args:
      - login
      - --username=${_DOCKERHUB_USERNAME}
      - --password=${_DOCKERHUB_PAT}
    secretEnv: ["_DOCKERHUB_PAT"]

  - name: "gcr.io/cloud-builders/docker"
    id: Build Docker Image
    args:
      - build
      - -t
      - docker.io/${_DOCKERHUB_USERNAME}/${_DOCKERHUB_REPO_NAME}:${COMMIT_SHA}
      - .

  - name: "gcr.io/cloud-builders/docker"
    id: Push Docker Image to Docker Hub
    args:
      - push
      - docker.io/${_DOCKERHUB_USERNAME}/${_DOCKERHUB_REPO_NAME}:${COMMIT_SHA}

  - name: "gcr.io/cloud-builders/gcloud"
    id: Deploy to Cloud Run
    args:
      - run
      - deploy
      - ${_CLOUD_RUN_SERVICE_NAME}
      - --image=docker.io/${_DOCKERHUB_USERNAME}/${_DOCKERHUB_REPO_NAME}:${COMMIT_SHA}
      - --region=${_REGION}
      - --platform=managed
      - --allow-unauthenticated
      - --port=8080
      - --set-env-vars=NEXT_PUBLIC_SANITY_PROJECT_ID=${_SANITY_PROJECT_ID},NEXT_PUBLIC_SANITY_DATASET=${_SANITY_DATASET}
      - --update-secrets=SANITY_API_TOKEN=${_SANITY_API_TOKEN_SECRET_NAME}

images:
  - docker.io/${_DOCKERHUB_USERNAME}/${_DOCKERHUB_REPO_NAME}:${COMMIT_SHA}

secrets:
  - secretEnv:
      _DOCKERHUB_PAT: projects/travelogue-443615/secrets/DOCKERHUB_PAT/versions/latest
      SANITY_API_TOKEN: projects/travelogue-443615/secrets/SANITY_API_TOKEN/versions/latest

substitutions:
  _CLOUD_RUN_SERVICE_NAME: travelogue
  _DOCKERHUB_REPO_NAME: travelogue
  _DOCKERHUB_USERNAME: samuelajayii
  _REGION: europe-west1
  _SANITY_PROJECT_ID: inojoc9p
  _SANITY_DATASET: production
  _SANITY_API_TOKEN_SECRET_NAME: SANITY_API_TOKEN
